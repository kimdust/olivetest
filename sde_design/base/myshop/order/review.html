<!--@layout(/layout/basic/layout.html)-->

<div class="review_list_tab">
    <a class="review_wait active" href="/myshop/order/review.html">작성 대기</a>
    <a class="review_done" href="/myshop/order/review_list.html">작성한 리뷰</a>
</div>

<div class="review_wait_list">
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  (async function main(){
    const REVIEW_API = 'https://oliva.boundary.team/api/reviews/check-written';
    const CONTAINER  = document.querySelector('.review_wait_list');

    function getCookieRaw(name){
      const rows = document.cookie ? document.cookie.split('; ') : [];
      for (const row of rows){
        const i = row.indexOf('=');
        const k = i === -1 ? row : row.slice(0, i);
        if (k === name) return decodeURIComponent(i === -1 ? '' : row.slice(i + 1));
      }
      return '';
    }

    function getUserIdFromCookie(){
      const raw = getCookieRaw('login_provider_1');
      if (!raw) return '';
      try { const j = JSON.parse(raw); return j.member_id || j.id || j.uid || ''; }
      catch { return raw; }
    }

    function text(el){ return (el?.textContent || '').trim(); }
    function qsParam(href, key){
      try { return new URL(href, location.origin).searchParams.get(key) || ''; }
      catch { return ''; }
    }
    
    function extractProductId(scope){
      const a = scope.querySelector('.thumbnail a, .description .prdName a');
      const href1 = a?.getAttribute('href') || '';
      let m = href1 && (href1.match(/(?:product_no|product_id)=(\d+)/) || href1.match(/\/product\/.*?\/(\d+)(?:\/|$)/));
      if (m) return m[1];
      const reviewBtn = scope.closest('.order')?.querySelector('a.btnNormal.sizeS[href*="/board/product/write"]');
      const href2 = reviewBtn?.getAttribute('href') || '';
      return qsParam(href2, 'product_no') || qsParam(href2, 'product_id') || '';
    }

    function extractOrderId(scope){
      const order = scope.closest('.order');
      const hrefs = [
        order?.querySelector('.btnDetail[href]')?.getAttribute('href') || '',
        order?.querySelector('.ec-base-button a[href*="param_apply"]')?.getAttribute('href') || '',
        order?.querySelector('a.btnNormal.sizeS[href*="/board/product/write"]')?.getAttribute('href') || ''
      ].filter(Boolean);
      for (const href of hrefs){
        const id = qsParam(href, 'order_id') || qsParam(href, 'order_no') || qsParam(href, 'ordno') || qsParam(href, 'orderId');
        if (id) return id;
      }
      return '';
    }

    async function hasWrittenReview({ user_id, product_id, order_id }){
      if (!user_id || !product_id || !order_id){
        console.warn('[review] params missing → treat as NOT written', { user_id, product_id, order_id });
        return false;
      }
      try{
        const res  = await fetch(REVIEW_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ user_id, product_id, order_id })
        });
        const data = await res.json().catch(() => ({}));
        console.log('[review] API', res.status, { user_id, product_id, order_id, data });
        if (!res.ok) return false;
        return !!data.exists;
      }catch(e){
        console.warn('[review] API error → treat as NOT written', e);
        return false;
      }
    }

    const brandCache = window.sessionStorage;
    function getDetailUrl(scope){
      const a = scope.querySelector('.thumbnail a, .description .prdName a');
      return a ? a.getAttribute('href') : '';
    }

    function brandKey(url){
      if (!url) return null;
      const m = url.match(/product_no=(\d+)/) || url.match(/\/product\/.*?\/(\d+)(?:\/|$)/);
      return 'brand:' + (m ? m[1] : url);
    }

    async function fetchBrand(url){
      if (!url) return '';
      const key = brandKey(url);
      const c = key && brandCache.getItem(key);
      if (c != null) return c;

      try{
        const res  = await fetch(url, { credentials: 'same-origin' });
        const html = await res.text();
        const doc  = new DOMParser().parseFromString(html, 'text/html');
        const cand = [
          '.product_detail_brand',
          '.product_brand',
          '[data-role="productBrand"]',
          '.xans-product-detail .infoArea .brand',
          'meta[itemprop="brand"]',
          'meta[property="product:brand"]'
        ];
        let brand = '';
        for (const sel of cand){
          const el = doc.querySelector(sel);
          if (!el) continue;
          if (el.tagName === 'META' && el.getAttribute('content')) { brand = el.getAttribute('content').trim(); break; }
          const t = text(el);
          if (t) { brand = t; break; }
        }
        brandCache.setItem(key, brand || '');
        return brand || '';
      }catch(e){
        console.warn('[brand] fetch fail', url, e);
        return '';
      }
    }

    const userId = getUserIdFromCookie();
    console.log('[review] userId:', userId);

    const html = await fetch('/myshop/order/list.html', { credentials: 'same-origin' }).then(r => r.text());
    const doc  = new DOMParser().parseFromString(html, 'text/html');
    const orders = [...doc.querySelectorAll('.order')];

    const candidates = [];
    for (const order of orders){
      const statusTxt = text(order.querySelector('.txtStatus')).replace(/\s+/g,'');
      if (!/배송완료/.test(statusTxt)) continue;

      const infos = order.querySelectorAll('.ec-base-prdInfo');
      infos.forEach(info => {
        const writeBtn = order.querySelector('a.btnNormal.sizeS[href*="/board/product/write"]');
        if (!writeBtn) return;

        const productId = extractProductId(info);
        const orderId   = extractOrderId(info);
        const name      = text(info.querySelector('.description .prdName a, .description .prdName'));
        const thumb     = info.querySelector('.thumbnail img')?.getAttribute('src') || '';
        const detailUrl = getDetailUrl(info);
        const writeHref = writeBtn.getAttribute('href') || '';

        console.log('[review:item raw]', { name, productId, orderId, statusTxt, detailUrl, writeHref });

        candidates.push({ name, thumb, productId, orderId, detailUrl, writeHref });
      });
    }

    async function buildCards(list){
      const CHUNK = 6;
      const out = [];
      for (let i = 0; i < list.length; i += CHUNK){
        const slice = list.slice(i, i + CHUNK);
        const part  = await Promise.all(slice.map(async (it) => {
          const exists = await hasWrittenReview({ user_id: userId, product_id: it.productId, order_id: it.orderId });
          if (exists) return null;
          const brand = await fetchBrand(it.detailUrl);
          return { ...it, brand };
        }));
        out.push(...part.filter(Boolean));
      }
      return out;
    }

    const items = await buildCards(candidates);

    if (!items.length){
      CONTAINER.innerHTML = `
        <div class="order_empty">
          작성 가능한 주문이 없습니다.
        </div>`;
      console.log('[review] result empty');
      return;
    }

    const frag = document.createDocumentFragment();
    items.forEach(it => {
      let writeUrl = '#';
      try { writeUrl = new URL(it.writeHref, location.origin).pathname + new URL(it.writeHref, location.origin).search; }
      catch { writeUrl = it.writeHref || '#'; }

      const card = document.createElement('div');
      card.className = 'rv-card';
      card.innerHTML = `
        <div class="rv-link">
          <a class="rv-thumb" href="${it.detailUrl || '#'}">${it.thumb ? `<img alt="" src="${it.thumb}">` : ''}</a>
          <div class="rv-meta">
            <div class="rv-name">${it.name || ''}</div>
          </div>
        </div>
        <a class="rv-cta" href="${writeUrl}" data-from="review-wait">리뷰 작성하기</a>
        `;
      frag.appendChild(card);
    });
    CONTAINER.innerHTML = '';
    CONTAINER.appendChild(frag);

    console.log('[review] rendered items:', items.length);
  })();
});
</script>

<style>
#contents {
  min-height: calc(100vh - 54px);
  padding-bottom: 0;
}

#review_header {
  position: relative;
  justify-content: center;
  display: flex;
  width: 100%;
  padding: 16px;
  align-items: center;
  background-color: #FFF;
}

#review_header .header_back {
    position: absolute;
    left: 16px;
    top: 16px;
    width: 24px;
}

#review_header .header_back img {
  width: 100%;
}

#review_header p {
  color: var(--G-800, var(--Gray-800, #393939));
  text-align: center;
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 22px; /* 137.5% */
  letter-spacing: -0.32px;
}

.review_list_tab {
  margin: -16px -16px 0;
  display: flex;
  align-items: center;
  border-bottom: 1px solid #E3E3E3;
  background-color: #FFF;
}

.review_wait, .review_done {
  display: flex;
  height: 48px;
  padding: 14px 24px;
  justify-content: center;
  align-items: center;
  gap: 10px;
  flex: 1 0 0;
  color: var(--G-600, var(--Gray-600, #767676));
  text-align: center;
  font-size: 15px;
  font-style: normal;
  font-weight: 600;
  line-height: 20px; /* 133.333% */
  letter-spacing: -0.3px;
}

.review_wait.active {
  border-bottom: 2px solid var(--Olive-Green, #1B8862);
  color: var(--Olive-Green, #1B8862);
  text-align: center;
  font-size: 15px;
  font-style: normal;
  font-weight: 600;
  line-height: 20px; /* 133.333% */
  letter-spacing: -0.3px;
}

.review_wait_list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 20px;
}

.rv-card {
  display: flex;
  padding: 16px;
  flex-direction: column;
  align-items: flex-start;
  gap: 16px;
  align-self: stretch;
  border-radius: 12px;
  background: var(--G-0, #FFF);
}

.rv-link {
  display: flex;
  align-items: center;
  gap: 12px;
  align-self: stretch;
}

.rv-thumb {
  display: flex;
  width: 70px;
  height: 70px;
  justify-content: center;
  align-items: center;
  aspect-ratio: 1/1;
}

.rv-thumb img {
  width: 100%;
  border-radius: 8px;
  aspect-ratio: 1/1;
}

.rv-brand {
  color: var(--G-600, var(--Gray-600, #767676));
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}

.rv-name {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  color: var(--G-900, #181818);
  text-overflow: ellipsis;
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 22px; /* 137.5% */
  letter-spacing: -0.32px;
}

.rv-cta {
  display: flex;
  padding: 12px 16px;
  justify-content: center;
  align-items: center;
  gap: 8px;
  align-self: stretch;
  border-radius: 8px;
  border: 1px solid var(--G-300, #D9D9D9);
  background: var(--G-0, #FFF);
  color: var(--G-700, #454545);
  font-size: 16px;
  font-style: normal;
  font-weight: 400;
  line-height: 22px; /* 137.5% */
  letter-spacing: -0.32px;
}

.order_empty {
    color: var(--G-300, #B0B0B0);
  text-align: center;
  font-size: 18px;
  font-style: normal;
  font-weight: 500;
  line-height: 24px;
  letter-spacing: -0.36px;
  margin: auto;
  height: 80vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

</style>