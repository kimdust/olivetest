<!--@layout(/layout/basic/layout.html)-->
<div class="section" module="board_writePackage_4">
  <!--@css(/css/module/board/writePackage.css)-->
    <div module="board_write_4">
        <!--
        $write_success_url = /board/product/list.html
        $product_select_url = /product/search_board_list.html
        $order_select_url   = /order/search_board_list.html
        $login_page_url     = /member/login.html
        $deny_access_url    = /index.html
        -->
        <div class="ec-base-box typeProduct product_wrap {$display_product|display}">
            <p class="thumbnail">
                <a href="{$link_product_detail}">
                <img id="{$product_img_id}" src="{$url_product_img}" onerror="this.src='//img.echosting.cafe24.com/thumb/75x75.gif'" alt="">
                </a>
            </p>
            <div class="information">
                <h3><a href="/product/detail.html{$param_product}" id="{$product_name_link_id}">{$product_name}</a></h3>
                <p class="price">{$product_price} {$product_tax_type_text}</p>
            </div>
        </div>

        <div id="custom-review-form">
            <div id="reviewForm">
                <div class="review_form_item">
                  <h3 class="review_form_title">
                      테이스트 평가
                      <span class="review_required">*</span>
                  </h3>
                  <div class="review_section_wrap" style="padding: 40px 24px 28px 24px">
                    <div class="profile_item">
                      <label>프루티</label>
                      <div class="taste-slider" data-target="fruity" data-max="10" aria-label="프루티 점수 (1~10)"></div>
                      <input type="hidden" name="fruity" required>
                    </div>

                    <div class="profile_item">
                      <label>매운맛</label>
                      <div class="taste-slider" data-target="spicy" data-max="10" aria-label="매운맛 점수 (1~10)"></div>
                      <input type="hidden" name="spicy" required>
                    </div>

                    <div class="profile_item">
                      <label>쓴맛</label>
                      <div class="taste-slider" data-target="bitter" data-max="10" aria-label="쓴맛 점수 (1~10)"></div>
                      <input type="hidden" name="bitter" required>
                    </div>
                  </div>
                </div>

                <div class="review_form_item">
                  <h3 class="review_form_title">
                    사진 업로드 <span class="review_not_required">(선택)</span>
                  </h3>

                  <div class="image-upload">
                    <!-- 숨긴 실제 파일 인풋 -->
                    <input type="file" id="reviewImages" name="images[]" multiple accept="image/*" class="visually-hidden-file" tabindex="-1">

                    <!-- 업로드 버튼 타일 -->
                    <label for="reviewImages" class="upload-tile" aria-label="사진 업로드">
                      <!-- 아이콘은 필요 시 교체 -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="21" viewBox="0 0 20 21" fill="none">
                        <path d="M2.3076 20.0254C1.73262 20.0254 1.24593 19.8262 0.847561 19.4278C0.449187 19.0294 0.25 18.5428 0.25 17.9678V2.73338C0.25 2.1584 0.449187 1.67172 0.847561 1.27334C1.24593 0.874968 1.73262 0.675781 2.3076 0.675781H9.99053C10.2324 0.675781 10.4351 0.757638 10.5986 0.92135C10.7623 1.08506 10.8442 1.28785 10.8442 1.52972C10.8442 1.77178 10.7623 1.97448 10.5986 2.13781C10.4351 2.30134 10.2324 2.3831 9.99053 2.3831H2.3076C2.20535 2.3831 2.12141 2.41592 2.05577 2.48155C1.99014 2.54719 1.95732 2.63113 1.95732 2.73338V17.9678C1.95732 18.07 1.99014 18.154 2.05577 18.2196C2.12141 18.2852 2.20535 18.3181 2.3076 18.3181H17.542C17.6442 18.3181 17.7282 18.2852 17.7938 18.2196C17.8595 18.154 17.8923 18.07 17.8923 17.9678V10.2848C17.8923 10.043 17.9741 9.84028 18.1378 9.67676C18.3016 9.51304 18.5043 9.43119 18.7462 9.43119C18.9883 9.43119 19.191 9.51304 19.3543 9.67676C19.5178 9.84028 19.5996 10.043 19.5996 10.2848V17.9678C19.5996 18.5428 19.4004 19.0294 19.002 19.4278C18.6037 19.8262 18.117 20.0254 17.542 20.0254H2.3076ZM3.53346 15.6914H16.3161L12.3435 10.3944L8.92886 14.8269L6.51016 11.7514L3.53346 15.6914ZM15.6159 4.65952H14.1931C13.9512 4.65952 13.7484 4.57766 13.5847 4.41395C13.4212 4.25024 13.3394 4.04745 13.3394 3.80558C13.3394 3.56352 13.4212 3.36082 13.5847 3.19749C13.7484 3.03397 13.9512 2.9522 14.1931 2.9522H15.6159V1.52944C15.6159 1.28757 15.6977 1.08487 15.8614 0.92135C16.0251 0.757638 16.2279 0.675781 16.4698 0.675781C16.7119 0.675781 16.9146 0.757638 17.0779 0.92135C17.2414 1.08487 17.3232 1.28757 17.3232 1.52944V2.9522H18.7459C18.9878 2.9522 19.1905 3.03406 19.354 3.19777C19.5177 3.36149 19.5996 3.56428 19.5996 3.80615C19.5996 4.04821 19.5177 4.2509 19.354 4.41424C19.1905 4.57776 18.9878 4.65952 18.7459 4.65952H17.3232V6.08229C17.3232 6.32416 17.2413 6.52695 17.0776 6.69066C16.9139 6.85418 16.7111 6.93594 16.4692 6.93594C16.2272 6.93594 16.0245 6.85418 15.8611 6.69066C15.6976 6.52695 15.6159 6.32416 15.6159 6.08229V4.65952Z" fill="#888888"/>
                      </svg>
                    </label>

                    <!-- 썸네일 리스트 -->
                    <div id="imagePreviewList" class="image-previews" aria-live="polite"></div>
                  </div>

                  <p class="guide_txt"><span class="dot"></span><span class="highlight_txt">첨부파일의 용량은 최대 10MB</span>까지 등록할 수 있습니다<br><span class="blank_box"></span>(파일 크기가 3MB인 경우 최대 3개까지 업로드 가능)</p>
                </div>

                <div class="review_form_item">
                    <h3 class="review_form_title">
                      리뷰 작성
                      <span class="review_required">*</span>
                    </h3>
                    <div class="review_section_wrap" style="gap: 4px; align-items: flex-end;">
                      <textarea id="reviewComment" name="comment" rows="4" maxlength="200" required
                          placeholder="주문하신 올리브 오일의 맛과 향에 대해 자세히 써주시면 더 유용한 리뷰가 돼요."></textarea>
                      <div class="char-counter">
                        <span id="currentCount">0</span>/200
                      </div>
                    </div>
                </div>

                <div class="review_form_item">
                    <h3 class="review_form_title">
                        만족도 평가
                        <span class="review_required">*</span>
                    </h3>
                    <div class="review_section_wrap" style="gap: 16px; align-items: center;">
                        <div class="star-rating" data-target="rating" data-max="5" aria-label="만족도 별점 (1~5)"></div>
                        <input type="hidden" name="rating">
                        <p class="rating_info">별점을 눌러 상품에 대한 만족도를 평가해주세요.</p>
                    </div>
                </div>
                
                <label style="display:none;"><input type="checkbox" name="agree" checked>개인정보 수집 및 이용에 동의합니다.</label>

                <div class="ec-base-button gBottom">
                <span class="gRight">
                    <button type="button" class="btnSubmitFix sizeM" id="customReviewSubmitBtn">리뷰 등록</button>
                </span>
                </div>
            </div>
        </div>
    </div>
    </div>
<div id="fileSizeModal" class="c-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="c-modal__backdrop" data-close></div>
  <div class="c-modal__panel" role="document">
    <div class="c-modal__content">
      <svg xmlns="http://www.w3.org/2000/svg" width="26" height="23" viewBox="0 0 26 23" fill="none">
        <path d="M1.70156 22.128C1.47556 22.128 1.27256 22.0728 1.09256 21.9623C0.912556 21.8519 0.772668 21.7062 0.67289 21.5253C0.56889 21.3458 0.511668 21.1513 0.501223 20.942C0.490779 20.7327 0.547223 20.5253 0.670556 20.32L12.0849 0.602667C12.2084 0.397334 12.3629 0.245557 12.5482 0.147335C12.7338 0.0491126 12.9291 0 13.1342 0C13.3393 0 13.5347 0.0491126 13.7202 0.147335C13.9056 0.245557 14.06 0.397334 14.1836 0.602667L25.5979 20.32C25.7212 20.5253 25.7777 20.7327 25.7672 20.942C25.7568 21.1513 25.6996 21.3458 25.5956 21.5253C25.4958 21.7062 25.3559 21.8519 25.1759 21.9623C24.9959 22.0728 24.7929 22.128 24.5669 22.128H1.70156ZM13.1342 18.5383C13.4393 18.5383 13.6951 18.4351 13.9016 18.2287C14.108 18.0222 14.2112 17.7664 14.2112 17.4613C14.2112 17.1562 14.108 16.9004 13.9016 16.694C13.6951 16.4876 13.4393 16.3843 13.1342 16.3843C12.8291 16.3843 12.5733 16.4876 12.3669 16.694C12.1604 16.9004 12.0572 17.1562 12.0572 17.4613C12.0572 17.7664 12.1604 18.0222 12.3669 18.2287C12.5733 18.4351 12.8291 18.5383 13.1342 18.5383ZM13.1346 15.051C13.4181 15.051 13.6556 14.9552 13.8469 14.7637C14.0384 14.5719 14.1342 14.3343 14.1342 14.051V9.38433C14.1342 9.101 14.0383 8.86356 13.8466 8.672C13.6548 8.48022 13.4172 8.38433 13.1339 8.38433C12.8503 8.38433 12.6129 8.48022 12.4216 8.672C12.23 8.86356 12.1342 9.101 12.1342 9.38433V14.051C12.1342 14.3343 12.2301 14.5719 12.4219 14.7637C12.6137 14.9552 12.8512 15.051 13.1346 15.051Z" fill="#ABABAB"/>
      </svg>
      <p class="c-modal_text_strong">사진 용량을 확인해주세요</p>
      <p class="c-modal_text">3MB 이하 사진 첨부 바랍니다.</p>
      <!-- <p id="fileSizeModalMsg"></p> -->
      <button type="button" class="c-modal__btn" data-close>확인</button>
    </div>
  </div>
</div>
<script>


window.LoginCookie = (function () {
  function readCookie(name) {
    const prefix = name + '=';
    const hit = document.cookie.split('; ').find(c => c.startsWith(prefix));
    return hit ? hit.slice(prefix.length) : '';
  }
  function parse(raw) {
    if (!raw) return null;
    let decoded = '';
    try { decoded = decodeURIComponent(raw); } catch { decoded = raw; }
    try {
      const obj = JSON.parse(decoded);
      const id = obj.member_id || obj.memberId || obj.memberid;
      if (id) return { id, raw: obj };
    } catch (_) {}
    try {
      const qs = new URLSearchParams(decoded);
      const id = qs.get('member_id') || qs.get('memberId') || qs.get('memberid');
      if (id) return { id, raw: Object.fromEntries(qs.entries()) };
    } catch (_) {}
    return null;
  }
  function getId() {
    const raw1 = readCookie('login_provider_1');
    const raw0 = readCookie('login_provider');
    const info = parse(raw1) || parse(raw0);
    return info ? String(info.id) : '';
  }
  return { getId };
})();

function getLoginMemberIdFromCookie() {
  return window.LoginCookie.getId();
}

function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
function dbg() { try { console.log.apply(console, ['[review]'].concat([].slice.call(arguments))); } catch (_) {} }

function goBack() {
  if (document.referrer) location.href = document.referrer;
  else if (history.length > 1) history.back();
  else location.href = '/';
}

document.addEventListener('DOMContentLoaded', function () {
  const textarea = document.getElementById('reviewComment');
  const counter = document.getElementById('currentCount');
  if (!textarea || !counter) return;
  const update = () => {
    let len = textarea.value.length;
    if (len > 200) { textarea.value = textarea.value.substring(0, 200); len = 200; }
    counter.textContent = len;
  };
  textarea.addEventListener('input', update);
  update();
});

async function compressImage(file, { maxW = 1600, maxH = 1600, quality = 0.85 } = {}) {
  const dataUrl = await new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
  const img = await new Promise((resolve, reject) => {
    const i = new Image();
    i.onload = () => resolve(i);
    i.onerror = reject;
    i.src = dataUrl;
  });
  const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
  const w = Math.round(img.width * ratio);
  const h = Math.round(img.height * ratio);

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
  const filename = file.name.replace(/\.(png|webp|heic|heif|gif)$/i, '') + '.jpg';
  return new File([blob], filename, { type: 'image/jpeg' });
}

(function(){
  const modal = document.getElementById('fileSizeModal');
  let lastFocused = null;

  window.openSizeModal = function(message){
    lastFocused = document.activeElement;
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden','false');
    modal.querySelector('[data-close]').focus();
  };
  function close(){
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden','true');
    if (lastFocused) lastFocused.focus();
  }
  modal.addEventListener('click', (e)=>{
    if (e.target.hasAttribute('data-close')) close();
  });
  document.addEventListener('keydown', (e)=>{
    if (modal.classList.contains('is-open') && (e.key==='Escape' || e.key==='Esc')) close();
  });
})();

(function () {
  const MAX_COUNT = 10;
  const MAX_SIZE_MB = 3;
  const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;
  const selected = [];
  window.__reviewSelectedImages = selected;

  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }
  async function getPreviewURL(file) {
    try {
      return { url: URL.createObjectURL(file), isDataUrl: false };
    } catch {
      try { return { url: await fileToDataURL(file), isDataUrl: true }; }
      catch { return { url: null, isDataUrl: false }; }
    }
  }

  function renderPreviews() {
    const wrap = document.getElementById('imagePreviewList');
    if (!wrap) return;
    wrap.innerHTML = '';
    selected.forEach((item, idx) => {
      const box = document.createElement('div');
      box.className = 'thumb';
      box.innerHTML = `
        ${item.url ? `<img alt="업로드 이미지 ${idx + 1}">`
                   : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:8px;text-align:center;font-size:11px;color:#999">미리보기 불가</div>`}
        <button type="button" class="remove-btn" aria-label="이미지 삭제">&times;</button>
      `;
      const img = box.querySelector('img');
      if (img && item.url) img.src = item.url;
      box.querySelector('.remove-btn').addEventListener('click', () => {
        if (item.url && !item.isDataUrl) URL.revokeObjectURL(item.url);
        selected.splice(idx, 1);
        renderPreviews();
        updateButtonState();
      });
      wrap.appendChild(box);
    });
    dbg('previews', selected.map(s => ({ name: s.file.name, size: s.file.size })));
  }

  async function addFiles(fileList) {
    if (!fileList || !fileList.length) return;

    for (const original of fileList) {
      let file = original;
      if (!file.type || !file.type.startsWith('image/')) continue;

      if (file.size > MAX_SIZE_BYTES) {
        openSizeModal(`'${file.name}'은(는) 3MB를 초과하여 업로드할 수 없습니다.`);
        continue;
      }

      if (selected.length >= MAX_COUNT) {
        openSizeModal(`이미지는 최대 ${MAX_COUNT}장까지 업로드할 수 있습니다.`);
        break;
      }
      if (selected.some(it => it.file.name === file.name && it.file.size === file.size)) continue;

      const prev = await getPreviewURL(file);
      selected.push({ file, ...prev });
    }
    renderPreviews();
    updateButtonState();
  }

  document.addEventListener('change', (e) => {
    const t = e.target;
    if (t && t.id === 'reviewImages') {
      addFiles([...t.files]);
      t.value = '';
    }
  }, true);

  const tile = document.querySelector('.upload-tile');
  if (tile) {
    const prevent = e => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter', 'dragover'].forEach(ev => tile.addEventListener(ev, (e) => { prevent(e); tile.classList.add('drop-over'); }));
    ['dragleave', 'drop'].forEach(ev => tile.addEventListener(ev, (e) => { prevent(e); tile.classList.remove('drop-over'); }));
    tile.addEventListener('drop', (e) => { addFiles([...e.dataTransfer.files]); });
  }
})();

function initTasteSlider(el) {
  const max = Number(el.dataset.max) || 10;
  const target = el.dataset.target;
  const hidden = document.querySelector(`[name="${target}"]`);
  if (!hidden) return;

  el.setAttribute('role', 'slider');
  el.setAttribute('aria-valuemin', '1');
  el.setAttribute('aria-valuemax', String(max));
  el.setAttribute('tabindex', '0');

  const frag = document.createDocumentFragment();
  for (let i = 0; i < max; i++) {
    const seg = document.createElement('div');
    seg.className = 'dash';
    frag.appendChild(seg);
  }
  el.appendChild(frag);

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = '0';
  el.appendChild(bubble);

  let value = 0;
  function setValue(v, emit = true) {
    value = clamp(v, 1, max);
    hidden.value = String(value);
    el.setAttribute('aria-valuenow', String(value));
    bubble.textContent = String(value);
    el.querySelectorAll('.dash').forEach((d, i) => i < value ? d.classList.add('filled') : d.classList.remove('filled'));
    const rect = el.getBoundingClientRect();
    const stepW = rect.width / max;
    bubble.style.left = (stepW * (value - 0.5)) + 'px';
    if (emit) el.dispatchEvent(new CustomEvent('change', { detail: { value } }));
    updateButtonState();
  }
  const posToValue = clientX => {
    const r = el.getBoundingClientRect();
    const ratio = (clientX - r.left) / r.width;
    return clamp(Math.round(ratio * max + 0.5), 1, max);
  };

  let dragging = false;
  const down = e => { dragging = true; setValue(posToValue(e.touches ? e.touches[0].clientX : e.clientX)); e.preventDefault(); };
  const move = e => { if (dragging) setValue(posToValue(e.touches ? e.touches[0].clientX : e.clientX), false); };
  const up = () => { dragging = false; };

  el.addEventListener('mousedown', down);
  el.addEventListener('touchstart', down, { passive: false });
  window.addEventListener('mousemove', move);
  window.addEventListener('touchmove', move, { passive: false });
  window.addEventListener('mouseup', up);
  window.addEventListener('touchend', up);

  el.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowUp') setValue((value || 0) + 1);
    else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') setValue((value || 0) - 1);
    else if (e.key === 'Home') setValue(1);
    else if (e.key === 'End') setValue(max);
  });

  setValue(Number(hidden.value) || Math.ceil(max / 2));
}
function initStarRating(el) {
  const max = Number(el.dataset.max) || 5;
  const target = el.dataset.target;
  const hidden = document.querySelector(`[name="${target}"]`);
  if (!hidden) return;

  const frag = document.createDocumentFragment();
  for (let i = 0; i < max; i++) {
    const s = document.createElement('span');
    s.className = 'star';
    s.textContent = '★';
    frag.appendChild(s);
  }
  el.appendChild(frag);

  let value = 0;
  function setValue(v) {
    value = clamp(v, 1, max);
    hidden.value = String(value);
    el.querySelectorAll('.star').forEach((st, i) => i < value ? st.classList.add('filled') : st.classList.remove('filled'));
    el.dispatchEvent(new CustomEvent('change', { detail: { value } }));
    updateButtonState();
  }
  const pointerVal = clientX => {
    const r = el.getBoundingClientRect();
    return clamp(Math.ceil(((clientX - r.left) / r.width) * max), 1, max);
  };

  let dragging = false;
  el.addEventListener('mousedown', e => { dragging = true; setValue(pointerVal(e.clientX)); });
  window.addEventListener('mousemove', e => { if (dragging) setValue(pointerVal(e.clientX)); });
  window.addEventListener('mouseup', () => dragging = false);

  el.addEventListener('touchstart', e => { dragging = true; setValue(pointerVal(e.touches[0].clientX)); }, { passive: true });
  window.addEventListener('touchmove', e => { if (dragging) setValue(pointerVal(e.touches[0].clientX)); }, { passive: true });
  window.addEventListener('touchend', () => dragging = false);

  el.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowUp') setValue((value || 0) + 1);
    else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') setValue((value || 0) - 1);
    else if (e.key === 'Home') setValue(1);
    else if (e.key === 'End') setValue(max);
  });

  setValue(Number(hidden.value) || 1);
}

function updateButtonState() {
  const btn = document.getElementById('customReviewSubmitBtn');
  if (!btn) return;
  const required = ['fruity', 'spicy', 'bitter', 'rating'];
  const comment = document.querySelector('[name="comment"]');
  const ok = required.every(n => (document.querySelector(`[name="${n}"]`)?.value || '').trim() !== '')
            && comment && comment.value.trim() !== '';
  btn.classList.toggle('active', !!ok);
}

document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.taste-slider').forEach(initTasteSlider);
  document.querySelectorAll('.star-rating').forEach(initStarRating);
  updateButtonState();
});

(function () {
  const btn = document.getElementById('customReviewSubmitBtn');
  if (!btn) return;

  btn.addEventListener('click', function guard(e) {
    const need = ['fruity', 'spicy', 'bitter', 'rating'];
    for (const n of need) {
      const v = document.querySelector(`[name="${n}"]`)?.value;
      if (!v) { alert('평가를 모두 입력해 주세요.'); e.preventDefault(); return; }
    }
    const comment = document.querySelector('[name="comment"]')?.value || '';
    if (!comment.trim()) { alert('리뷰 내용을 입력해 주세요.'); e.preventDefault(); return; }
  }, { capture: true });

  btn.addEventListener('click', async function () {
    if (!btn.classList.contains('active')) return;
    if (btn.disabled) return;
    btn.disabled = true;

    const formData = new FormData();
    const pick = sel => document.querySelector(sel)?.value || '';
    const productName = document.querySelector('#sPrdName')?.textContent.trim() || '';

    formData.append('rating', pick('[name="rating"]'));
    formData.append('fruity', pick('[name="fruity"]'));
    formData.append('spicy', pick('[name="spicy"]'));
    formData.append('bitter', pick('[name="bitter"]'));
    formData.append('comment', pick('[name="comment"]'));
    formData.append('product_id', pick('[name="product_no"]'));
    formData.append('product_name', productName);
    formData.append('order_id', pick('[name="order_id"]'));
    formData.append('user_id', getLoginMemberIdFromCookie() || 'guest');
    formData.append('agree', '1');

    const selected = window.__reviewSelectedImages || [];
    selected.forEach(it => formData.append('images[]', it.file));

    try {
      const res = await fetch('https://oliva.boundary.team/api/reviews', { method: 'POST', body: formData });
      const text = await res.text();
      let json; try { json = JSON.parse(text); } catch { throw new Error('서버 응답이 JSON이 아님: ' + text); }

      if (res.ok) {
        alert('리뷰가 등록되었습니다.');
        goBack();
        return;
      } else {
        alert(json?.message || '리뷰 등록에 실패하였습니다.');
      }
    } catch (err) {
      console.error(err);
      alert('리뷰 등록에 실패하였습니다.');
    } finally {
      btn.disabled = false;
    }
  });
})();

(function initReviewIntroDim(){
  if (sessionStorage.getItem('review_intro_dim_closed') === '1') return;
  const tasteWrap = (() => {
    const t = document.querySelector('.review_section_wrap .taste-slider');
    return t ? t.closest('.review_section_wrap') : null;
  })();
  if (!tasteWrap) return;

  const dim = document.createElement('div');
  dim.id = 'reviewIntroDim';
  dim.innerHTML = `
    <div class="layer" aria-hidden="true"><div class="preview"></div></div>
    <div class="tip" role="dialog" aria-modal="true" aria-live="polite">그래프를 터치해서 평점을 입력해보세요!</div>
  `;

  const cloned = tasteWrap.cloneNode(true);
  cloned.querySelectorAll('*').forEach(el => { el.setAttribute('tabindex','-1'); el.style.pointerEvents='none'; });
  cloned.querySelectorAll('input[type="hidden"]').forEach(inp => { if (inp.nextSibling && inp.nextSibling.nodeType === Node.TEXT_NODE) inp.parentNode.removeChild(inp.nextSibling); inp.style.display = 'none'; });

  cloned.querySelectorAll('.taste-slider').forEach(sl => {
    const max = Number(sl.dataset.max) || 10;
    if (!sl.querySelector('.dash')) {
      const frag = document.createDocumentFragment();
      for (let i=0;i<max;i++){ const d=document.createElement('div'); d.className='dash'; frag.appendChild(d); }
      sl.appendChild(frag);
    }
    let bubble = sl.querySelector('.bubble');
    const val = Math.ceil(max/2);
    if (!bubble){ bubble=document.createElement('div'); bubble.className='bubble'; sl.appendChild(bubble); }
    bubble.textContent = String(val);
    sl.querySelectorAll('.dash').forEach((d,i)=> i<val ? d.classList.add('filled') : d.classList.remove('filled'));
    sl.__previewVal = val;
  });

  dim.querySelector('.preview').appendChild(cloned);

  const layer = dim.querySelector('.layer');
  const tip   = dim.querySelector('.tip');
  function layoutPreview(){
    const r = tasteWrap.getBoundingClientRect();
    layer.style.position = 'fixed';
    layer.style.left = r.left + 'px';
    layer.style.top  = r.top  + 'px';
    layer.style.width  = r.width + 'px';
    layer.querySelector('.preview').style.width = '100%';
    tip.style.position = 'fixed';
    tip.style.left = (r.left + r.width/2) + 'px';
    tip.style.top  = (r.bottom + 18) + 'px';
    tip.style.transform = 'translateX(-50%)';
    requestAnimationFrame(() => {
      cloned.querySelectorAll('.taste-slider').forEach(sl => {
        const max = Number(sl.dataset.max) || 10;
        const val = sl.__previewVal || Math.ceil(max/2);
        const rr = sl.getBoundingClientRect();
        const stepW = rr.width / max;
        const bubble = sl.querySelector('.bubble');
        if (bubble) bubble.style.left = (stepW * (val - 0.5)) + 'px';
      });
    });
  }

  const close = () => {
    dim.classList.add('hide');
    sessionStorage.setItem('review_intro_dim_closed', '1');
    document.body.style.overflow = '';
    setTimeout(() => dim.remove(), 200);
  };

  dim.addEventListener('click', close, { passive:true });
  document.addEventListener('keydown', e => { if (dim.classList.contains('show') && e.key === 'Escape') close(); });

  const mount = () => { document.body.appendChild(dim); document.body.style.overflow = 'hidden'; layoutPreview(); };
  (document.readyState === 'loading') ? document.addEventListener('DOMContentLoaded', mount) : mount();
  window.addEventListener('resize', layoutPreview);
  window.addEventListener('orientationchange', layoutPreview);
})();

(function setupLeaveConfirm(){
  function buildModal(){
    if (document.getElementById('leaveConfirmDim')) return;
    const dim = document.createElement('div');
    dim.id = 'leaveConfirmDim';
    dim.innerHTML = `
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="leave-title">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="27" height="23" viewBox="0 0 27 23" fill="none">
          <path d="M1.99 22.68c-.23 0-.43-.06-.61-.17a1.02 1.02 0 0 1-.42-.77c-.1-.18-.16-.38-.17-.59-.01-.21.05-.42.18-.62L12.38 1.16a1.1 1.1 0 0 1 1.06-.6c.2 0 .39.06.57.17.18.1.33.25.45.43l11.41 19.72c.12.2.18.41.17.62-.01.21-.07.41-.17.59-.1.18-.24.33-.42.44-.18.11-.38.17-.6.17H1.99Zm11.44-3.59c.3 0 .55-.1.76-.31.21-.21.31-.46.31-.76 0-.3-.1-.56-.31-.77a1.05 1.05 0 0 0-.76-.32c-.3 0-.55.11-.77.32-.21.21-.32.47-.32.77 0 .3.11.55.32.76.22.21.47.31.77.31Zm.00-3.49c.28 0 .52-.1.72-.3.2-.2.3-.44.3-.72V9.94c0-.28-.1-.52-.3-.72-.2-.2-.44-.3-.72-.3-.28 0-.52.1-.72.3-.2.2-.3.44-.3.72v4.67c0 .28.1.52.3.72.2.2.44.3.72.3Z" fill="#ABABAB"/>
        </svg>
        <div id="leave-title" class="title">리뷰 쓰기 화면을 나갈까요?</div>
        <div class="desc">작성 중인 내용이 사라져요!</div>
        <div class="btns">
          <button type="button" class="btn btn-later">나중에 작성</button>
          <button type="button" class="btn btn-continue">이어서 작성</button>
        </div>
      </div>
    `;
    document.body.appendChild(dim);

    const close = () => { dim.classList.remove('show'); document.body.style.overflow = ''; };
    const leave = () => { goBack(); };

    dim.querySelector('.btn-continue').addEventListener('click', close);
    dim.querySelector('.btn-later').addEventListener('click', leave);
    document.addEventListener('keydown', e => { if (dim.classList.contains('show') && e.key === 'Escape') close(); });

    window.__openLeaveConfirm = function(){
      dim.classList.add('show');
      document.body.style.overflow = 'hidden';
    };
  }

  function bindBack(){
    const candidates = ['#review_write_header .header_back', '#review_write_header .header_back a', '.header_back', '.gnb_back', '.btn-back'];
    const back = candidates.map(s => document.querySelector(s)).find(Boolean);
    if (!back) return;
    back.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      window.__openLeaveConfirm && window.__openLeaveConfirm();
    }, { capture:true });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => { buildModal(); bindBack(); });
  else { buildModal(); bindBack(); }
})();

</script>

<style>
#review_write_header {
  position: relative;
  justify-content: center;
  display: flex;
  width: 100%;
  padding: 16px;
  align-items: center;
}

#review_write_header .header_back {
  position: absolute;
  left: 16px;
  top: 16px;
  width: 24px;
}

#review_write_header .header_back img {
  width: 100%;
}

#review_write_header p {
  color: var(--G-800, var(--Gray-800, #393939));
    text-align: center;
    font-size: 16px;
    font-style: normal;
    font-weight: 600;
    line-height: 22px; /* 137.5% */
    letter-spacing: -0.32px;
}

.product_wrap {
  display: flex;
  width: 100%;
  padding: 8px;
  align-items: center;
  gap: 12px;
  border-radius: 10px;
  background: var(--G-0, #FFF);  
}

.product_wrap .thumbnail,
.product_wrap .thumbnail a {
  width: 70px;
  height: 70px;
  display: flex;
  aspect-ratio: 1/1;
}

.product_wrap .thumbnail a img {
  width: 100%;
  object-fit: cover;
  object-position: center;
  border-radius: 8px;
  aspect-ratio: 1/1;
}

#sPrdName {
  overflow: hidden;
  color: var(--G-900, #181818);
  text-overflow: ellipsis;    
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  font-size: 14px;
  font-style: normal;
  font-weight: 600;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}

#sPrdPrice {
  color: var(--G-400, #888);
  font-family: Pretendard;
  font-size: 12px;
  font-style: normal;
  font-weight: 400;
  line-height: 16px;
  margin-top: 4px;
}

#reviewForm {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  gap: 32px;
}

.review_form_item {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.review_section_wrap {
  display: flex;
  padding: 16px;
  flex-direction: column;
  align-items: flex-start;
  gap: 30px;
  align-self: stretch;
  border-radius: 10px;
  background: #FFF;
}

.profile_item {
  display: flex;
  gap: 28px;
  align-items: center;
  width: 100%;
}

.profile_item label {
  color: var(--G-900, #181818);
  font-family: Pretendard;
  font-size: 14px;
  font-style: normal;
  font-weight: 600;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.028px;
  width: 36.5px;
  white-space: nowrap;
  flex-shrink: 0;
}

.taste-slider,
.star-rating {
  user-select: none;
}

.taste-slider {
  position: relative;
  width: 100%;
  max-width: 520px;
  height: 32px;
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 12px 0;
}

.taste-slider .dash {
  flex: 1 1 0;
  height: 4px;
  border-radius: 6px;
  background: #E8E8E8;
  transition: background-color .15s ease;
}

.taste-slider .dash.filled {
  background: #198F6A;
}

.taste-slider .bubble {
  position: absolute;
  width: 30px;
  top: -20px;
  transform: translateX(-50%);
  padding: 2px 4px;
  border-radius: 4px;
  background: #198F6A;
  color: var(--G-0, #FFF);
  text-align: center;
  font-size: 12px;
  font-style: normal;
  font-weight: 600;
  line-height: 18px; /* 150% */
  pointer-events: none;
  white-space: nowrap;
}

.taste-slider .bubble::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: -5px;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid #198F6A;
}

.taste-slider:focus {
  outline: none;
}

.taste-slider:focus-visible {
  outline: 2px solid #198F6A;
  outline-offset: 4px;
}

.star-rating {
  display: inline-flex;
  gap: 8px;
  font-size: 36px;
  line-height: 1;
  cursor: pointer;
}

.star-rating .star {
  font-size: 24px;
  color: #E3E3E3;
  transition: transform .1s ease, opacity .1s ease;
}

.star-rating .star.filled {
  color: #198F6A;
}

.star-rating .star:active {
  transform: scale(.95);
}

.star-rating:focus {
  outline: none;
}

.star-rating:focus-visible {
  outline: 2px solid #198F6A;
  outline-offset: 6px;
}

.review_form_title {
  color: var(--G-900, #181818);
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 20px; /* 125% */
  letter-spacing: -0.32px;
  display: flex;
  gap: 4px;
}

.review_form_title .review_required {
  color: var(--Point, #F46200);
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 20px;
  letter-spacing: -0.32px;
}

.review_form_title .review_not_required {
  color: var(--G-400, var(--Gray-400, #ABABAB));
  font-size: 14px;
  font-style: normal;
  font-weight: 500;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}

textarea[name="comment"] {
  width: 100%;
  display: flex;
  height: 120px;
  padding: 12px 14px;
  align-items: flex-start;
  border-radius: 8px;
  border: 1px solid #E7E7E7;
  background: #FFF;
  color: var(--G-700, #454545);
  font-size: 14px;
  font-style: normal;
  font-weight: 500;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
  resize: none;
}

textarea[name="comment"]::placeholder {
  color: var(--G-400, var(--Gray-400, #ABABAB));
  font-size: 14px;
  font-style: normal;
  font-weight: 500;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}

.char-counter,
#currentCount {
  color: var(--G-400, var(--Gray-400, #ABABAB));
  font-size: 12px;
  font-style: normal;
  font-weight: 400;
  line-height: 18px; /* 150% */
  letter-spacing: -0.24px;
}

.rating_info {
  color: var(--G-500, var(--Gray-500, #888));
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}

.image-upload {
  display: flex;
  flex-direction: row-reverse;
  align-items: flex-start;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.image-upload:has(#imagePreviewList .thumb) {
  gap: 10px; /* 원하는 gap 값 */
}

.upload-tile {
  width: 80px;
  height: 80px;
  border-radius: 16px;
  border: 1px solid #E3E3E3;
  background: #F0F0F0;
  color: #9A9A9A;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  text-align: center;
  font-size: 12px;
}

.image-previews {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  max-width: 100%;
}

.image-previews .thumb {
  position: relative;
  width: 80px;
  height: 80px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #E6E6E6;
  background: #fff;
}
.image-previews .thumb img {
  width: 100%; height: 100%;
  object-fit: cover;
}

.image-previews .remove-btn {
  position: absolute;
  top: 6px; right: 6px;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: rgba(0,0,0,.6);
  color: #fff;
  border: none;
  font-size: 14px;
  line-height: 22px;
  text-align: center;
  cursor: pointer;
}
.image-previews .remove-btn:focus-visible {
  outline: 2px solid #198F6A;
  outline-offset: 2px;
}

.upload-tile.drop-over {
  border-color: #198F6A;
  box-shadow: 0 0 0 3px rgba(25,143,106,.15) inset;
}

.visually-hidden-file {
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: 0;
  overflow: hidden;
  clip: rect(0,0,0,0);
  border: 0;
}

.ec-base-button {
  position: fixed;
  left: 0;
  bottom: 0;
  display: flex;
  width: 100%;
  padding: 16px 16px 32px 16px;
  justify-content: space-between;
  align-items: center;
  align-self: stretch;
  background: var(--G-0, #FFF);
  box-shadow: 0 0 12px 0 rgba(140, 140, 140, 0.20);
}

.gRight {
  width: 100%;
}

#customReviewSubmitBtn {
  display: flex;
  width: 100%;
  height: 48px;
  padding: 10px;
  justify-content: center;
  align-items: center;
  gap: 10px;
  flex: 1 0 0;
  border-radius: 8px;
  background: var(--Gray-100, #F0F0F0);
  color: var(--G-400, var(--Gray-400, #ABABAB));
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 24px; /* 150% */
  letter-spacing: -0.32px;
  border: none;
}

#customReviewSubmitBtn.active {
  background-color: #198F6A;
  color: var(--G-0, #FFF);
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 24px; /* 150% */
  letter-spacing: -0.32px;
}

#reviewIntroDim {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  padding: 16px 16px 24px;
  opacity: 1;
  transition: opacity .2s ease;
}

#reviewIntroDim.hide {
  opacity: 0;
}

#reviewIntroDim .preview {
  width: 100%;
  margin-bottom: 12px;
  border-radius: 12px;
  background: #fff;
  overflow: hidden;
  pointer-events: none;
  transform: translateZ(0);
  position: relative;
}

#reviewIntroDim .preview .review_section_wrap {
  margin: 0 !important;
}

#reviewIntroDim .tip {
  position: relative;
  min-width: 212px;
  border-radius: 12px;
  background: #fff;
  padding: 12px 14px;
  text-align: center;
  color: var(--G-900, #181818);
  text-align: center;
  font-size: 12px;
  font-style: normal;
  font-weight: 400;
  line-height: 18px;
  letter-spacing: -0.24px;
}

#reviewIntroDim .tip::before {
  content: "";
  position: absolute;
  top: -8px; left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-bottom: 12px solid #fff;
  border-radius: 4px;
}

#leaveConfirmDim{
  position:fixed; inset:0; z-index:10000;
  background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center;
}
#leaveConfirmDim.show{ display:flex; }

#leaveConfirmDim .modal {
  border-radius: 12px;
  background: var(--G-0, #FFF);
  display: flex;
  width: 295px;
  padding: 20px 14px;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

#leaveConfirmDim .modal .icon {
  width: 28px;
  height: 28px;
  margin:0 auto 8px;
}

#leaveConfirmDim .title {
  color: var(--G-900, #181818);
  text-align: center;
  font-size: 18px;
  font-style: normal;
  font-weight: 600;
  line-height: 26px; /* 144.444% */
  letter-spacing: -0.36px;
}

#leaveConfirmDim .desc {
  color: var(--G-500, var(--Gray-500, #888));
  text-align: center;
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
  margin-top: 4px;
}

#leaveConfirmDim .btns {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  align-self: stretch;
}

#leaveConfirmDim .btn {
  display: flex;
  padding: 10px 12px;
  justify-content: center;
  align-items: center;
  gap: 4px;
  flex: 1 0 0;
  border-radius: 8px;
  border: none;
  margin-top: 20px;
}

#leaveConfirmDim .btn-later {
  background:#F0F0F0;
  color: var(--G-600, var(--Gray-600, #767676));
  font-size: 14px;
  font-style: normal;
  font-weight: 500;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}

#leaveConfirmDim .btn-continue {
  background: #198F6A;
  color: var(--G-0, #FFF);
  font-size: 14px;
  font-style: normal;
  font-weight: 500;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}

.dot::before {
  content: "•"; /* 불릿 문자 사용 */
  color: red;
  font-size: 14px;
  line-height: 1;
  padding: 12px;
}

.highlight_txt{
  color: var(--Discount-Red, var(--Discount-Red, #F44336));
/* M 12 */
font-family: Pretendard;
font-size: 12px;
font-style: normal;
font-weight: 500;
line-height: 18px; /* 150% */
letter-spacing: -0.24px;
}

.guide_txt{
  color: var(--G-500, var(--Gray-500, #888));
/* M 12 */
font-family: Pretendard;
font-size: 12px;
font-style: normal;
font-weight: 500;
line-height: 18px;
letter-spacing: -0.24px;
}

.blank_box{
width: 30px;
display: inline-block;
}

.c-modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999
}
.c-modal.is-open{
  display:flex
}
.c-modal__backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.5)
}
.c-modal__panel{
  position:relative;
  z-index:1;
  background:#fff;
  border-radius:10px;
  width: 295px;
  padding: 20px 16px 16px 16px;
  box-shadow:0 8px 24px rgba(0,0,0,.18)
}
.c-modal__content{
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}
.c-modal_text_strong{
  color: var(--G-900, #181818);
  text-align: center;
  /* SB 18 */
  font-family: Pretendard;
  font-size: 18px;
  font-style: normal;
  font-weight: 600;
  line-height: 26px; /* 144.444% */
  letter-spacing: -0.36px;
}
.c-modal_text{
  color: var(--G-500, var(--Gray-500, #888));
  text-align: center;
  /* R 14 */
  font-family: Pretendard;
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
  line-height: 20px; /* 142.857% */
  letter-spacing: -0.28px;
}
.c-modal__btn{
  margin-top: 18px;
  padding:8px 14px;
  border:0;
  border-radius:8px;
  width: 100%;
  height: 48px;
  background: var(--Olive-Green, #1B8862);color:#fff;cursor:pointer
  }
</style>